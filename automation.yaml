###########################################
#               AUTOMATIONS               #
###########################################
###
#  UI
###
# Set theme on start-up
- alias: 'Set theme on start-up'
  id: 5b3806c0-2bcc-4bc8-b538-ce724c934817
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: frontend.set_theme
      data:
        name: noctis
    - service: input_select.select_option
      data:
        entity_id: input_select.theme_list
        option: Noctis
# Select theme manually
- alias: 'Select theme'
  id: 653bfb33-82f2-4b2d-9c9c-cb4e1087f8df
  trigger:
    platform: state
    entity_id: input_select.theme_list
  action:
    - service_template: >-
        {% if trigger.to_state.state == 'Noctis' %}
          script.set_noctis
        {% elif trigger.to_state.state == 'Synthwave' %}
          script.set_synthwave
        {% endif %}

###
# GLOBAL
###
# Turn-off movement detection at Shabat\Chag
- alias: 'Enable Shabat Mode at Shabat\Chag'
  id: 501ee07f-794c-4b49-ba18-5e21f111510c
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'on'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.shabat_mode
    - service: switch.turn_on
      entity_id: switch.shabat_mode
# Turn-on movement detection at Shabat\Chag end
- alias: 'Disable Shabat Mode at Shabat\Chag'
  id: 6b9bd845-cb16-4fb9-bad2-003aeb2b9363
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'off'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.shabat_mode
    - service: switch.turn_off
      entity_id: switch.shabat_mode

# Turn-off movement detection in multisensors at Shabat\Chag
- alias: 'Disable Multisensors Motion sensors'
  id: 011001b9-dfee-43fb-b635-9f3f1c81388a
  trigger:
    platform: state
    entity_id: switch.shabat_mode
    to: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.shabat_select
# Turn-on movement detection in multisensors at Shabat\Chag end
- alias: 'Enable Multisensors Motion sensors'
  id: 2fcfe963-6207-4429-ad51-1656eaed14dd
  trigger:
    platform: state
    entity_id: switch.shabat_mode
    to: 'off'
  action:
    - service: switch.turn_off
      entity_id: switch.shabat_select

### Shabat and Chag
- alias: 'Shabat and Chag Lighting'
  id: 66aff0fc-7022-4577-9d72-2f35104ca746
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'on'
  condition:
    - condition: state
      entity_id: group.person
      state: 'home'
  action:
    - service: script.turn_on
      entity_id: script.shabat_chag_lighting_sequence

- alias: 'Shabat and Chag Lighting off'
  id: 84dba792-958c-432e-bfb4-db8266bb3f0a
  trigger:
    platform: template
    value_template: >
      {{ states('sensor.time') == states('input_select.shabat_lights_off_time') }}
  condition:
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  action:
    - service: light.turn_off
      data:
        entity_id: light.public_lights
        transition: 300

- alias: 'Shabat Morning lighting'
  id: 3ac9405a-dde0-41f2-850b-413cb15a708d
  trigger:
    platform: time
    at: '08:00:00'
  condition: # add condition based on light amount
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
          state: 'on'
        - condition: state
          entity_id: group.person
          state: 'home'
  action:
    - service: light.turn_on
      data:
        entity_id: light.public_lights
        transition: 120
        brightness_pct: 70

- alias: 'Shabat Morning Dining lighting'
  id: d2980177-8560-43f1-9fc4-26afd6406e73
  trigger:
    platform: time
    at: '09:30:00'
  condition: # add condition based on light amount
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
          state: 'on'
        - condition: state
          entity_id: group.person
          state: 'home'
  action:
    - service: light.turn_on
      data:
        entity_id: light.dining_lights
        transition: 60
        brightness_pct: 100

- alias: 'Shabat and Chag end lighting'
  id: 92ec94d8-89b9-4417-9c03-5711d20e5d32
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'off'
  condition:
    - condition: state
      entity_id: group.person
      state: 'home'
  action:
    - service: script.turn_on
      entity_id: script.shabat_chag_end_lighting_sequence

###
# VACUUM
###
# Vacuum waits until everybody left
#- alias: 'Vacuum waits until everybody left'
#  id: 0a5f46de-effa-4b82-a4f3-b0508dbd4095
#  trigger:
#    platform: state
#    entity_id: group.person
#    to: 'not_home'
#  condition:
#    - condition: time
#      after: '07:00:00'
#      before: '20:00:00'
#    - condition: state
#      entity_id: binary_sensor.workday_sensor
#      state: 'on'
#    - condition: state
#      entity_id: input_boolean.cleaned_today
#      state: 'off'
#  action:
#    - service: vacuum.start
#      entity_id: vacuum.xiaomi_vacuum_cleaner
#    - service: notify.mobile_app_mi_9t
#      data:
#        title: 'Now Cleaning'
#        message: 'The house Was empty - so anyway, I started cleaning.'
#    - service: notify.mobile_app_redmi_note_7
#      data:
#        title: 'Now Cleaning'
#        message: 'The house Was empty - so anyway, I started cleaning.'

# Vacuum return to dock if in error state more then 1 hr
#- alias: 'Return to dock if error for 1 hr'
#  id: c70477c9-66c0-43db-9036-570aa6bfcb09
#  trigger:
#    platform: state
#    entity_id: vacuum.xiaomi_vacuum_cleaner
#    from: 'cleaning'
#    to: 'error'
#    for: '01:00:00'
#  action:
#    - service: vacuum.return_to_base
#      entity_id: vacuum.xiaomi_vacuum_cleaner
#    - service: notify.mobile_app_mi_9t
#      data:
#        title: 'Returning to Dock'
#        message: 'You left me in the Dark, So I am Returning Home. Please don't forget to check the brush!'
#    - service: notify.mobile_app_redmi_note_7
#      data:
#        title: 'Returning to Dock'
#        message: 'You left me in the Dark, So I am Returning Home. Please don't forget to check the brush!'

# Set vacuum input_boolean to 'on' even if turned-on manually for minimal cleaning time
#- alias: 'Vacuum - set to cleaned today'
#  id: 8d53ce02-066c-4a51-a369-3e13d1220cee
#  trigger:
#    platform: state
#    entity_id: vacuum.xiaomi_vacuum_cleaner
#    to: 'cleaning'
#    for: '00:10:00'
#  action:
#    - service: input_boolean.turn_on
#      entity_id: input_boolean.cleaned_today

# Reset cleaning counter
#- alias: Vacuum - reset 'cleaned today'
#  id: a4801806-74ca-46ca-abdd-f5cf47ebedc2
#  initial_state: 'on'
#  trigger:
#    platform: time
#    at: '00:00:00'
#  action:
#    - service: input_boolean.turn_off
#      entity_id: input_boolean.cleaned_today

# Vacuum - Intelligent Mode
#- alias: 'Intelligent Turbo mode'
#  id: c8258c50-16dd-4b3d-b743-7a806bdb1018
#  trigger:
#    platform: state
#    entity_id: group.person
#    to: 'not_home'
#  action:
#    - service: script.vacuum_set_turbo
#- alias: 'Intelligent Quiet mode'
#  id: f4000e26-b404-4d74-93a0-85b9900a7278
#  trigger:
#    platform: state
#    entity_id: group.person
#    to: 'home'
#  action:
#    - service: script.vacuum_set_silent

# Vacuum - Set mode
#- alias: 'Vacuum - set mode'
#  id: 339c44db-f51b-4174-b396-18e69213b4e7
#  trigger:
#    platform: state
#    entity_id: input_select.vacuum_fan_speed_list
#  action:
#    - service_template: >-
#        {% if trigger.to_state.state == 'Silent' %}
#          script.vacuum_set_silent
#        {% elif trigger.to_state.state == 'Standard' %}
#          script.vacuum_set_standard
#        {% elif trigger.to_state.state == 'Medium' %}
#          script.vacuum_set_medium
#        {% elif trigger.to_state.state == 'Turbo' %}
#          script.vacuum_set_turbo
#        {% elif trigger.to_state.state == 'Gentle' %}
#          script.vacuum_set_gentle
#        {% endif %}

###
# KITCHEN
###
## Lights
# Turn on sink lights to max when someone in the kitchen
#- alias: 'Sink lights max brightness'
#  id: ec0d69d8-ec67-4146-81f1-de85066a37a7
#  trigger:
#    platform: state
#    to: 'on'
#    entity_id: sensor.kitchen_work_movement
#  condition:
#    - condition: state
#      entity_id: input_boolean.movement_detection
#      state: 'on'
#  action:
#    - service: light.turn_on
#      data:
#        entity_id: light.kitchen_work_light
#        brightness_pct: 100

## Shabat Plate
# Turn-off in Shabat at 11:00am
- alias: 'Shabat Enter operation' #Precoution for Shabat after Chag
  id: 175ea9fb-d7b6-419f-992d-a7cea43a7420
  trigger:
    platform: sun
    event: sunset
  condition:
      - condition: time
        weekday:
          - fri
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.shabat_plate
- alias: 'Shabat operation'
  id: 48acb771-25fe-4629-9ce7-77dfc35adeab
  trigger:
    platform: time
    at: '11:30:00'
  condition:
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.shabat_plate

# Chag operations
- alias: 'Start Chag timer'
  id: f6711174-7249-43d3-a70a-e1a9fa147ffe
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'on'
  condition:
    - condition: time
      weekday:
        - sun
        - mon
        - tue
        - wed
        - thu
  action:
    - service: timer.start
      data:
        entity_id: timer.chag_eve_plate  
    - service: switch.turn_on
      data:
        entity_id: switch.shabat_plate 

- alias: 'Turn-off plate on chag eve'
  id: ab698dfc-9a41-4f15-bf63-cd95eaf95ee2
  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.chag_eve_plate
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.shabat_plate 

- alias: 'Chag operation'
  id: 6a09b0cc-64f7-4cae-8d02-14ae61fe37fc
  trigger:
    platform: time
    at: '08:00:00'
  condition: 
    - condition: and
      conditions:
        - condition: time
          weekday:
            - sun
            - mon
            - tue
            - wed
            - thu
        - condition: state
          entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
          state: 'on'
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.shabat_plate 

# Turn-on in Shabat for 'seuda-shlishit'
- alias: 'Seuda-Shlishit'
  id: eec856fd-3958-4296-984a-c62458c75c97
  trigger:
    platform: sun
    event: sunset
    offset: '-03:30:00'
  condition:
    - condition: time
      weekday:
        - sat
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.shabat_plate

# Turn-off at the end of shabat/Chag
- alias: 'Shabat/Chag ends'
  id: 0cb6679a-5286-419e-95be-fe5c2850a247
  trigger:
    platform: state
    entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
    to: 'off'
  action:
    - service: switch.turn_off
      entity_id: switch.shabat_plate

###
# MASTER BEDROOM
###
## Lights
# Turn-off fairy lights at night
#- alias: 'turn off master-bedroom fairy lights at night'
#  id: 1a5b17ca-d49e-4ffb-b665-9fe4cd63d904
#  trigger:
#    platform: time
#    at: '23:00:00'
#  action:
#    - service: light.turn_off
#      entity_id: light.wled

### Lights
# Turn-off lights when away
- alias: 'Turn-off lights when away'
  id: c4219e30-3edb-4e1d-9621-eba64f593883
  trigger:
    platform: state
    entity_id: group.person
    to: 'not_home'
  action:
    - service: light.turn_off
      entity_id: light.all_lights

# Light-up in the morning
- alias: 'Turn on living room lights in workday morning-early'
  id: ab50f735-f05f-454e-813c-0ed8cdd4a51e
  trigger:
    platform: time
    at: '05:45:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
        - condition: state
          entity_id: group.person
          state: 'home'
  action:
    - service: light.turn_on
      data:
        entity_id: light.living_room_lights
        kelvin: 2800
        brightness_pct: 30
        transition: 300
- alias: 'Turn on living room lights in workday morning-later'
  id: 3a42a962-7bf3-4952-b8a2-99591aa827f5
  trigger:
    platform: time
    at: '06:30:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
        - condition: state
          entity_id: group.person
          state: 'home'
  action:
    - service: light.turn_on
      data:
        entity_id: light.living_room_lights
        kelvin: 4000
        brightness_pct: 100
        transition: 600

# Light-up master bedroom the morning
- alias: 'Turn on the master-bedroom lights in a workday morning'
  id: cb2d8573-74f4-440c-9b2e-23057b5e492c
  trigger:
    platform: time
    at: '06:45:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
        - condition: state
          entity_id: group.person
          state: 'home'
  action:
    - service: light.turn_on
      data:
        entity_id: light.master_bedroom
        kelvin: 3000
        brightness_pct: 60
        transition: 600

# Light-up night lights on movement detection
- alias: 'Turn on lights when movement detected at night'
  id: bbe9c72e-6578-4fd1-b25c-12908145ac14
  trigger:
    platform: state
    entity_id: binary_sensor.living_room_motion
    to: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.night
          state: 'on'
        - condition: state
          entity_id: 
            - binary_sensor.jewish_calendar_issur_melacha_in_effect
            - input_boolean.night_light_override
          state: 'off'
  action:
    - service: light.turn_on
      data:
        entity_id: light.bedroom1
        kelvin: 3500
        brightness_pct: 1
    - service: timer.start
      entity_id: timer.motion_lights_night
- alias: 'Turn off lights when movement is not detected set minutes after triggered'
  id: 395fbb3d-01ec-477e-a5dc-aab76acef310
  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.motion_lights_night
  action:
    - service: light.turn_off
      data:
        entity_id: light.bedroom1
        transition: 60

###
# Notifications
###
## Shabat notifications
- alias: 'Notify for Salatim'
  id: c5553611-fb7b-42d7-80af-2608a31c2c25
  trigger:
    platform: state
    entity_id: binary_sensor.shabat_notification_trigger_salatim
    to: 'on'
  condition:
    - condition: time
      weekday:
        - fri
  action:
    - service: notify.mobile_app_mi_9t
      data:
        title: 'שבת שלום!'
        message: 'זכרת להכין מיחם, חציל וסלטים אחרים?'
- alias: 'Notify for Shabat'
  id: 1145acf8-55b2-4564-bab8-94090f75d7d5
  trigger:
    platform: state
    entity_id: binary_sensor.shabat_notification_trigger
    to: 'on'
  condition:
    - condition: time
      weekday:
        - fri
  action:
    - service: notify.mobile_app_mi_9t
      data:
        title: 'שבת שלום!'
        message: 'שבת נכנסת בעוד 10 דקות.'
    - service: notify.mobile_app_redmi_note_7
      data:
        title: 'שבת שלום!'
        message: 'שבת נכנסת בעוד 10 דקות.'

###
# Climate
###
- alias: 'Turn off Living-Room AC at night'
  id: 5f250d83-aa9a-4e2a-af61-8ad83f39a75a
  trigger:
    platform: time
    at: '22:00:00'
  action:
    - service: climate.turn_off
      data:
        entity_id: climate.slvn

- alias: 'Turn on AC before arriving home'
  id: 4c8ce2bf-8e22-4959-8272-2faeb884cf8c
  trigger:
    platform: time
    at: '16:00:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.living_room_temp_thres
          state: 'off'
        - condition: state
          entity_id: binary_sensor.workday_sensor
          state: 'on'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.slvn
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.slvn
        temperature: 23
        mode: cool
- alias: 'Turn off AC if we did not arrived'
  id: ef558f55-51e6-4aaf-83db-72d066ad6826
  trigger:
    platform: time
    at: '16:45:00'
  condition:
    - condition: state
      entity_id: group.person
      state: 'not_home'
  action:
    - service: climate.turn_off
      data:
        entity_id: climate.slvn

- alias: 'Master bedroom AC night start'
  id: 830ce5bd-4949-4e8c-81f4-6363777ea9db
  trigger:
    - platform: time
      at: '19:00:00'
  condition:
    - condition: state
      entity_id: group.person
      state: 'home'
    - condition: state
      entity_id: binary_sensor.master_bedroom_temp_thres
      state: 'off'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.shynh
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.shynh
        temperature: 23
        mode: cool
- alias: 'Master Bedroom AC night climate on'
  id: 4bbb5a20-5b66-4a7f-ac31-09bc5e90a85b
  trigger:
    - platform: state
      entity_id: binary_sensor.master_bedroom_temp_thres
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: group.person
        state: 'home'
      - condition: time
        after: '20:00:00'
        before: '06:00:00'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.shynh
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.shynh
        temperature: 23
        mode: cool

- alias: 'Master bedroom AC shabbat morning start'
  id: 880cfa3e-b040-4e89-a04e-7832d2c28024
  trigger:
    - platform: time
      at: '07:00:00'
  condition:
    - condition: state
      entity_id: group.person
      state: 'home'
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.shynh
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.shynh
        temperature: 23
        mode: cool
- alias: 'Master Bedroom AC shabbat climate on'
  id: 880cfa3e-b040-4e89-a04e-7832d2c28024
  trigger:
    - platform: state
      entity_id: binary_sensor.master_bedroom_temp_thres
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: group.person
        state: 'home'
      - condition: time
        after: '07:00:00'
        before: '19:00:00'
      - condition: state
        entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
        state: 'on'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.shynh
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.shynh
        temperature: 23
        mode: cool

- alias: 'Master Bedroom AC comfort climate off'
  id: 4149a58b-7c72-4403-abd8-c211fc4e2cec
  trigger:
    - platform: state
      entity_id: binary_sensor.master_bedroom_temp_thres
      from: 'off'
      to: 'on'
      for:
        minutes: 30
  action:
    - service: climate.turn_off
      entity_id: climate.shynh

- alias: 'Turn on living room AC on shabbat morning if its hot'
  id: 7cc3353c-e1ba-4757-8d32-df0a9c853264
  trigger:
    - platform: time
      at: '09:00:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.person
        state: 'home'
      - condition: state
        entity_id: binary_sensor.living_room_temp_thres
        state: 'off'
      - condition: state
        entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
        state: 'on'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.slvn
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.slvn
        temperature: 24
        mode: cool
- alias: 'Living room AC comfort climate off'
  id: 4149a58b-7c72-4403-abd8-c211fc4e2cec
  trigger:
    - platform: state
      entity_id: binary_sensor.living_room_temp_thres
      from: 'off'
      to: 'on'
      for:
        minutes: 30
  action:
    - service: climate.turn_off
      entity_id: climate.slvn

- alias: 'Living room AC shabbat climate on'
  id: 4bbb5a20-5b66-4a7f-ac31-09bc5e90a85b
  trigger:
    - platform: state
      entity_id: binary_sensor.master_bedroom_temp_thres
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: group.person
        state: 'home'
      - condition: time
        after: '09:00:00'
        before: '19:00:00'
      - condition: state
        entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
        state:  'on'
  action:
    - service: climate.turn_on
      data:
        entity_id: climate.slvn
    - delay:
        seconds: 2
    - service: climate.set_temperature
      data:
        entity_id: climate.slvn
        temperature: 24
        mode: cool

- alias: 'Turn off all AC when shabbat ends'
  id: f570b89f-8ce5-4b09-9230-1acc55c54528
  trigger:
    - platform: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      to: 'off'
  action:
    - service: climate.turn_off
      data:
        entity_id: climate.slvn
    - service: climate.turn_off
      data:
        entity_id: climate.shynh